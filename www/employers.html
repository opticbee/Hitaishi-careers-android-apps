<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiring Companies | Hitaishi Careers</title>
    <meta name="description" content="Browse top companies hiring now. Filter by job type, location, experience and find your perfect job opportunity.">
    <!-- Favicon -->
    <link rel="icon" href="https://winjob.in/images/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a0dad; /* Updated primary color for consistency */
            --secondary-color: #d653c9;
            --dark-text: #333333;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        body {
            background-color: #f4f7fc;
            font-family: 'Poppins', sans-serif;
            color: #333;
            /* Space for fixed top header (80px) and fixed bottom nav (70px) */
            padding-top: 80px; 
            padding-bottom: 70px; 
        }

        /* --- FIXED TOP HEADER BAR --- */
        #mobile-header-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050; 
            padding: 35px 15px 10px 15px; /* 35px top margin */
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light-gray); /* Match body background */
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }

        #back-button, #filter-button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.5rem;
            padding: 0;
            cursor: pointer;
            transition: color 0.2s;
        }
        #back-button:active, #filter-button:active {
            color: var(--secondary-color);
        }

        #header-logo-title {
            display: flex;
            align-items: center;
        }
        #header-logo-title .fw-bold {
            color: var(--dark-text);
            font-size: 1.25rem;
        }
        /* --- END FIXED TOP HEADER BAR --- */

        /* --- OFFCANVAS FILTER STYLES (Sidebar) --- */
        .offcanvas-header {
            padding-top: 35px; /* Match the top margin of the main header */
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .offcanvas-body {
            padding: 15px;
        }
        .filter-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            background: white;
            box-shadow: none; /* No shadow in sidebar */
        }
        .filter-header {
            background-color: var(--light-gray);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: default;
        }
        .filter-header h6 {
            margin: 0;
            font-weight: 600;
            color: var(--primary-color);
        }
        .filter-body {
            padding: 10px 15px;
        }
        .filter-option {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        #industryList {
            max-height: 150px;
            overflow-y: auto;
            padding-right: 10px;
        }
        /* --- END OFFCANVAS STYLES --- */
        
        /* --- MAIN CONTENT LAYOUT --- */
        .main-container {
            display: block; /* Use block for mobile-first */
            padding: 15px;
        }
        
        .companies-container {
            width: 100%;
        }
        
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
            gap: 15px;
        }
        
        .company-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        
        .company-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }
        
        .company-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            margin-right: 15px;
        }

        .company-name {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .company-type {
            font-size: 0.8rem;
        }

        .job-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--card-shadow);
        }
        .job-title {
            font-size: 1rem;
        }
        .job-badge {
            font-size: 0.75rem;
        }
        
        .d-none-conditional {
            display: none !important;
        }

        /* --- FIXED BOTTOM NAVIGATION BAR --- */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background-color: #ffffff;
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1030;
        }

        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #6c757d;
            font-size: 0.7rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-icon i {
            font-size: 1.4rem;
            margin-bottom: 3px;
        }

        .nav-icon.active, .nav-icon:hover {
            color: var(--primary-color);
        }
    </style>
</head>
<body>

    <!-- ========================================================== -->
    <!-- FIXED TOP HEADER BAR -->
    <!-- ========================================================== -->
    <div id="mobile-header-bar">
        <!-- Back Button -->
        <button id="back-button" onclick="history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <!-- Title -->
        <div id="header-logo-title" class="d-flex align-items-center">
            <img src="images/logo.png" alt="Hitaishi Careers Logo" height="30" class="me-2" onerror="this.style.display='none'">
            <span class="fw-bold">Hitaishi Careers</span>
        </div>
        <!-- Filter/Hamburger Button -->
        <button id="filter-button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas" aria-controls="filterOffcanvas">
            <i class="fas fa-filter"></i>
        </button>
    </div>

    <main class="main-container">
        <!-- Content View (Companies or Jobs) -->
        <div class="companies-container">
            <!-- Search Box -->
            <div class="search-box">
                <div class="input-group mb-3">
                    <input type="text" id="companySearch" class="form-control" placeholder="Search companies or jobs...">
                    <button class="btn btn-primary" type="button" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Company Count -->
            <div class="company-count" id="companyCount">Loading companies...</div>
            
            <!-- Companies List View -->
            <div id="companies-view">
                <div id="companies-list" class="companies-grid">
                    <!-- Companies will be loaded here -->
                    <div class="text-center py-5" style="grid-column: 1 / -1;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading companies...</span>
                        </div>
                        <p class="mt-2">Loading companies...</p>
                    </div>
                </div>
            </div>
            
            <!-- Jobs List View (Hidden Initially) -->
            <div id="jobs-view" class="d-none">
                <div class="back-to-companies" id="backToCompanies">
                    <i class="fas fa-arrow-left"></i> Back to Companies
                </div>
                <div id="jobs-list">
                    <!-- Jobs will be loaded here when a company is selected -->
                </div>
            </div>
            
            <!-- No Results Message -->
            <div id="no-results" class="no-results d-none">
                <i class="fas fa-search"></i>
                <h4>No Companies Found</h4>
                <p>Try adjusting your filters or search terms</p>
            </div>
        </div>
    </main>

    <!-- ========================================================== -->
    <!-- OFFCANVAS SIDEBAR FOR FILTERS -->
    <!-- ========================================================== -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas" aria-labelledby="filterOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold" id="filterOffcanvasLabel">Filter Companies & Jobs</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            
            <!-- Posted Date Filter -->
            <div class="filter-card">
                <div class="filter-header"><h6>Posted Date (Job Filter)</h6></div>
                <div class="filter-body">
                    <div class="filter-option"><input type="radio" id="today" name="postedDate" value="today" class="me-2"><label for="today">Today</label></div>
                    <div class="filter-option"><input type="radio" id="week" name="postedDate" value="week" class="me-2"><label for="week">Last 7 days</label></div>
                    <div class="filter-option"><input type="radio" id="month" name="postedDate" value="month" class="me-2"><label for="month">Last month</label></div>
                    <div class="filter-option"><input type="radio" id="anytime" name="postedDate" value="anytime" class="me-2" checked><label for="anytime">Anytime</label></div>
                </div>
            </div>

            <!-- Job Type Filter -->
            <div class="filter-card">
                <div class="filter-header"><h6>Job Type</h6></div>
                <div class="filter-body">
                    <div class="filter-option"><input type="checkbox" id="fulltime" name="jobType" value="Full-time" class="me-2"><label for="fulltime">Full Time</label></div>
                    <div class="filter-option"><input type="checkbox" id="parttime" name="jobType" value="Part-time" class="me-2"><label for="parttime">Part Time</label></div>
                    <div class="filter-option"><input type="checkbox" id="contract" name="jobType" value="Contract" class="me-2"><label for="contract">Contract</label></div>
                    <div class="filter-option"><input type="checkbox" id="internship" name="jobType" value="Internship" class="me-2"><label for="internship">Internship</label></div>
                </div>
            </div>

            <!-- Industry Filter -->
            <div class="filter-card">
                <div class="filter-header"><h6>Industry</h6></div>
                <div class="filter-body">
                    <div class="input-group mb-2">
                        <input type="text" id="industrySearch" class="form-control form-control-sm" placeholder="Search industry...">
                    </div>
                    <div id="industryList" style="max-height: 150px; overflow-y: auto;">
                        <!-- Industries will be loaded dynamically -->
                        <div class="text-center small text-muted">Loading industries...</div>
                    </div>
                </div>
            </div>
            
            <!-- Location Filters -->
            <div class="filter-card">
                <div class="filter-header"><h6>Location</h6></div>
                <div class="filter-body">
                    <!-- Country Select -->
                    <div class="mb-2">
                        <label for="countrySelect" class="form-label small text-muted mb-1">Country</label>
                        <select id="countrySelect" class="form-select form-select-sm"></select>
                    </div>
                    <!-- State Select -->
                    <div id="stateContainer" class="mb-2 d-none-conditional">
                        <label for="stateSelect" class="form-label small text-muted mb-1">State</label>
                        <select id="stateSelect" class="form-select form-select-sm"></select>
                    </div>
                    <!-- City Select -->
                    <div id="cityContainer" class="mb-2 d-none-conditional">
                        <label for="citySelect" class="form-label small text-muted mb-1">City</label>
                        <select id="citySelect" class="form-select form-select-sm"></select>
                    </div>
                    <!-- Zip Code Select -->
                    <div id="zipCodeContainer" class="mb-0 d-none-conditional">
                        <label for="zipCodeSelect" class="form-label small text-muted mb-1">Zip Code</label>
                        <select id="zipCodeSelect" class="form-select form-select-sm"></select>
                    </div>
                </div>
            </div>
            <!-- End Location Filters -->

            <!-- Experience Filter -->
            <div class="filter-card">
                <div class="filter-header"><h6>Experience</h6></div>
                <div class="filter-body">
                    <div class="filter-option"><input type="checkbox" id="exp0-3" name="experience" value="0-3" class="me-2"><label for="exp0-3">0-3 years</label></div>
                    <div class="filter-option"><input type="checkbox" id="exp4-6" name="experience" value="4-6" class="me-2"><label for="exp4-6">4-6 years</label></div>
                    <div class="filter-option"><input type="checkbox" id="exp7-10" name="experience" value="7-10" class="me-2"><label for="exp7-10">7-10 years</label></div>
                    <div class="filter-option"><input type="checkbox" id="exp10plus" name="experience" value="10+" class="me-2"><label for="exp10plus">10+ years</label></div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button id="applyFilters" class="btn btn-primary btn-lg" data-bs-dismiss="offcanvas">Apply Filters</button>
                <button id="resetFilters" class="btn btn-outline-secondary">Reset All Filters</button>
            </div>
        </div>
    </div>


    <!-- ========================================================== -->
    <!-- FIXED BOTTOM NAVIGATION BAR -->
    <!-- ========================================================== -->
    <div id="bottom-nav">
        <a href="index.html" class="nav-icon">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="jobs.html" class="nav-icon">
            <i class="fas fa-briefcase"></i>
            <span>Jobs</span>
        </a>
        <a href="employer.html" class="nav-icon">
            <i class="fas fa-upload"></i>
            <span>Post Job</span>
        </a>
        <a href="employerlogin.html" class="nav-icon">
            <i class="fas fa-user-tie"></i>
            <span>Employer</span>
        </a>
        <a href="login.html" class="nav-icon">
            <i class="fas fa-user-circle"></i>
            <span>Jobseeker</span>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const companiesView = document.getElementById('companies-view');
            const jobsView = document.getElementById('jobs-view');
            const companiesList = document.getElementById('companies-list');
            const jobsList = document.getElementById('jobs-list');
            const backToCompanies = document.getElementById('backToCompanies');
            const companySearch = document.getElementById('companySearch');
            const searchButton = document.getElementById('searchButton');
            const companyCount = document.getElementById('companyCount');
            const noResults = document.getElementById('no-results');
            const applyFiltersBtn = document.getElementById('applyFilters');
            const resetFiltersBtn = document.getElementById('resetFilters');
            
            // Location Selectors
            const countrySelect = document.getElementById('countrySelect');
            const stateSelect = document.getElementById('stateSelect');
            const citySelect = document.getElementById('citySelect');
            const zipCodeSelect = document.getElementById('zipCodeSelect');
            
            // Location Containers (for show/hide logic)
            const stateContainer = document.getElementById('stateContainer');
            const cityContainer = document.getElementById('cityContainer');
            const zipCodeContainer = document.getElementById('zipCodeContainer');
            
            // Industry Elements
            const industrySearch = document.getElementById('industrySearch');
            const industryList = document.getElementById('industryList');
            
            // State
            let allCompanies = [];
            let filteredCompanies = [];
            let allJobs = []; // Array of ALL active jobs
            let selectedCompany = null;
            
            // Filter state 
            const filters = {
                postedDate: 'anytime',
                jobType: [],
                experience: [],
                industry: [],
                country: '', 
                state: '', 
                city: '', 
                zipCode: '' 
            };

            // --- Initialization ---
            const init = async () => {
                await loadCompanies();
                await loadJobs(); // Loads all active jobs for filter data
                initFilters();
                initEventListeners();
                applyFilters(); // Initial render based on no filters
            };

            // Load companies from backend
            const loadCompanies = async () => {
                try {
                    console.log('Fetching all companies...');
                    const response = await fetch('https://www.winjob.in/api/company/all');
                    if (!response.ok) throw new Error(`Failed to load companies, status: ${response.status}`);
                    const data = await response.json();
                    allCompanies = data.companies || [];
                    filteredCompanies = [...allCompanies];
                } catch (error) {
                    console.error('Error loading companies:', error);
                    companiesList.innerHTML = `<div class="alert alert-danger" style="grid-column: 1 / -1;">Failed to load companies. Check API status.</div>`;
                }
            };

            // Load jobs from backend
            const loadJobs = async () => {
                try {
                    console.log('Fetching all active jobs for filter reference...');
                    const response = await fetch('https://www.winjob.in/api/jobs/active');
                    if (!response.ok) throw new Error(`Failed to load jobs, status: ${response.status}`);
                    const data = await response.json();
                    allJobs = data.jobs || [];
                    
                    // Populate initial filters based on job data
                    populateCountries();
                    extractIndustries();
                } catch (error) {
                    console.error('Error loading reference jobs:', error);
                }
            };
            
            // --- Helper Functions for Filters ---

            // Render options in a select element
            const renderSelectOptions = (selectElement, options, currentValue) => {
                selectElement.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Select ${selectElement.id.replace('Select', '').replace('zipCode', 'Zip Code')}`;
                selectElement.appendChild(defaultOption);

                if (options && options.length > 0) {
                    options.sort().forEach(optionValue => {
                        if (optionValue) { // Ensure value is not null/empty
                            const option = document.createElement('option');
                            option.value = optionValue;
                            option.textContent = optionValue;
                            if (optionValue === currentValue) {
                                option.selected = true;
                            }
                            selectElement.appendChild(option);
                        }
                    });
                }
            };

            // Populate Country filter (top level)
            const populateCountries = () => {
                const countries = [...new Set(allJobs.map(job => job.country).filter(Boolean))];
                renderSelectOptions(countrySelect, countries, filters.country);
                // Reset visibility of cascading fields
                stateContainer.classList.add('d-none-conditional');
                cityContainer.classList.add('d-none-conditional');
                zipCodeContainer.classList.add('d-none-conditional');
            };

            // Populate State filter based on selected country
            const populateStates = () => {
                const currentCountry = filters.country;
                filters.state = ''; // Reset state filter
                filters.city = '';
                filters.zipCode = '';
                
                if (currentCountry) {
                    const matchingJobs = allJobs.filter(job => job.country === currentCountry);
                    const states = [...new Set(matchingJobs.map(job => job.state).filter(Boolean))];

                    renderSelectOptions(stateSelect, states, filters.state);
                    stateContainer.classList.remove('d-none-conditional');
                } else {
                    renderSelectOptions(stateSelect, [], filters.state);
                    stateContainer.classList.add('d-none-conditional');
                }
                populateCities(); // Cascade to reset cities/zips
            };

            // Populate City filter based on selected country and state
            const populateCities = () => {
                const currentCountry = filters.country;
                const currentState = filters.state;
                filters.city = ''; // Reset city filter
                filters.zipCode = '';
                
                if (currentCountry && currentState) {
                    let matchingJobs = allJobs.filter(job => 
                        job.country === currentCountry && job.state === currentState
                    );
                    
                    const cities = [...new Set(matchingJobs.map(job => job.city).filter(Boolean))];
                    
                    renderSelectOptions(citySelect, cities, filters.city);
                    cityContainer.classList.remove('d-none-conditional');
                } else {
                    renderSelectOptions(citySelect, [], filters.city);
                    cityContainer.classList.add('d-none-conditional');
                }
                populateZipCodes(); // Cascade to reset zips
            };

            // Populate Zip Code filter
            const populateZipCodes = () => {
                const currentCountry = filters.country;
                const currentState = filters.state;
                const currentCity = filters.city;
                filters.zipCode = ''; // Reset zip filter

                if (currentCountry && currentState && currentCity) {
                    let matchingJobs = allJobs.filter(job => 
                        job.country === currentCountry && 
                        job.state === currentState &&
                        job.city === currentCity
                    );

                    const zipCodes = [...new Set(matchingJobs.map(job => job.zip_code).filter(Boolean))];
                    
                    renderSelectOptions(zipCodeSelect, zipCodes, filters.zipCode);
                    zipCodeContainer.classList.remove('d-none-conditional');
                } else {
                    renderSelectOptions(zipCodeSelect, [], filters.zipCode);
                    zipCodeContainer.classList.add('d-none-conditional');
                }
            };
            
            // Extract unique industries from jobs for filter
            const extractIndustries = () => {
                const industries = [...new Set(allJobs.map(job => job.industry).filter(Boolean))];
                renderIndustryFilter(industries);
            };
            
            // Render industry filter options (checkboxes)
            const renderIndustryFilter = (industries) => {
                industryList.innerHTML = '';
                
                if (!industries || industries.length === 0) {
                    industryList.innerHTML = '<div class="text-muted small">No industries found</div>';
                    return;
                }
                
                industries.sort().forEach(industry => {
                    const id = `industry-${industry.replace(/\s+/g, '-')}`;
                    const option = document.createElement('div');
                    option.className = 'filter-option';
                    option.innerHTML = `
                        <input type="checkbox" id="${id}" name="industry" value="${industry}" class="me-2">
                        <label for="${id}">${industry}</label>
                    `;
                    industryList.appendChild(option);

                    // Re-bind change listener for dynamic list
                    option.querySelector('input').addEventListener('change', updateFilters);
                });
            };

            // --- Event Handling and Filter Logic ---

            // Function to update the global filters object based on all input states
            const updateFilters = () => {
                // Update Radio button (Posted Date)
                filters.postedDate = document.querySelector('input[name="postedDate"]:checked')?.value || 'anytime';

                // Update Checkboxes (Job Type, Experience)
                filters.jobType = [...document.querySelectorAll('input[name="jobType"]:checked')].map(cb => cb.value);
                filters.experience = [...document.querySelectorAll('input[name="experience"]:checked')].map(cb => cb.value);
                filters.industry = [...document.querySelectorAll('#industryList input[name="industry"]:checked')].map(cb => cb.value);

                // Update Location Selects - These are handled via specific 'change' listeners to manage cascading.
                // However, we include them here for completeness if a button triggers a full update.
                filters.country = countrySelect.value; 
                filters.state = stateSelect.value;
                filters.city = citySelect.value;
                filters.zipCode = zipCodeSelect.value;

                // Important: Trigger the main filtering function after updating state
                applyFilters();
            };

            // Initialize filters and their event listeners
            const initFilters = () => {
                // --- Location Cascading Logic ---
                countrySelect.addEventListener('change', (e) => {
                    filters.country = e.target.value;
                    populateStates();
                    updateFilters(); 
                });

                stateSelect.addEventListener('change', (e) => {
                    filters.state = e.target.value;
                    populateCities();
                    updateFilters(); 
                });

                citySelect.addEventListener('change', (e) => {
                    filters.city = e.target.value;
                    populateZipCodes();
                    updateFilters(); 
                });

                zipCodeSelect.addEventListener('change', (e) => {
                    filters.zipCode = e.target.value;
                    updateFilters(); 
                });
                
                // --- Other Filters (use 'change' to update and apply) ---
                document.querySelectorAll('input[name="postedDate"], input[name="jobType"], input[name="experience"]').forEach(input => {
                    input.addEventListener('change', updateFilters);
                });

                // Industry search filtering (visual only)
                industrySearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    industryList.querySelectorAll('.filter-option').forEach(option => {
                        const label = option.querySelector('label');
                        option.style.display = label.textContent.toLowerCase().includes(searchTerm) ? 'flex' : 'none';
                    });
                });
            };

            // Initialize general event listeners
            const initEventListeners = () => {
                applyFiltersBtn.addEventListener('click', updateFilters); // ApplyFilters button just calls updateFilters
                resetFiltersBtn.addEventListener('click', resetFilters);
                
                // Back button logic for job details view
                backToCompanies.addEventListener('click', () => {
                    jobsView.classList.add('d-none');
                    companiesView.classList.remove('d-none');
                    selectedCompany = null;
                });
                
                // Main search bar logic
                searchButton.addEventListener('click', searchCompanies);
                companySearch.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') searchCompanies();
                });
            };

            // Apply filters to companies
            const applyFilters = () => {
                if (allJobs.length === 0 || allCompanies.length === 0) {
                    console.log("Job or Company data not loaded, skipping filter application.");
                    return;
                }
                
                // 1. Find all unique company IDs that have at least one job matching ALL active filters.
                const companyIdsWithMatchingJobs = new Set(
                    allJobs.filter(job => jobMatchesFilters(job)).map(job => job.company_id)
                );
                
                // 2. Filter the companies list based on the IDs found above.
                filteredCompanies = allCompanies.filter(company => 
                    companyIdsWithMatchingJobs.has(company.id)
                );
                
                // 3. Apply the search term filter on the resulting list (since search is only on company name).
                const searchTerm = companySearch.value.trim().toLowerCase();
                if (searchTerm) {
                    filteredCompanies = filteredCompanies.filter(company => 
                        company.company_name.toLowerCase().includes(searchTerm)
                    );
                }
                
                renderCompanies();
            };

            // Check if a job matches current filters
            const jobMatchesFilters = (job) => {
                // --- Location Filters ---
                if (filters.country && job.country !== filters.country) return false;
                if (filters.state && job.state !== filters.state) return false;
                if (filters.city && job.city !== filters.city) return false;
                if (filters.zipCode && job.zip_code !== filters.zipCode) return false;
                
                // --- Posted Date Filter ---
                if (filters.postedDate !== 'anytime') {
                    const jobDate = new Date(job.created_at);
                    const today = new Date();
                    const daysDiff = (today - jobDate) / (1000 * 3600 * 24);
                    if ((filters.postedDate === 'today' && daysDiff > 1) ||
                        (filters.postedDate === 'week' && daysDiff > 7) ||
                        (filters.postedDate === 'month' && daysDiff > 30)) {
                        return false;
                    }
                }
                
                // --- Job Type Filter ---
                if (filters.jobType.length > 0 && !filters.jobType.includes(job.job_type)) {
                    return false;
                }

                // --- Industry Filter (based on job industry) ---
                if (filters.industry.length > 0 && !filters.industry.includes(job.industry)) {
                    return false;
                }
                
                // --- Experience Filter ---
                if (filters.experience.length > 0) {
                    const jobExp = parseInt(job.required_experience || '0');
                    const matchesExperience = filters.experience.some(expRange => {
                        if (expRange === '10+') return jobExp >= 10;
                        const [min, max] = expRange.split('-').map(Number);
                        return jobExp >= min && jobExp <= max;
                    });
                    if (!matchesExperience) return false;
                }
                
                return true;
            };

            // Reset filters
            const resetFilters = () => {
                // Reset primary filter state
                filters.postedDate = 'anytime';
                filters.jobType = [];
                filters.experience = [];
                filters.industry = [];
                filters.country = '';
                filters.state = '';
                filters.city = '';
                filters.zipCode = '';

                // Reset DOM elements
                document.querySelector('input[name="postedDate"][value="anytime"]').checked = true;
                document.querySelectorAll('.offcanvas-body input[type="checkbox"]').forEach(cb => cb.checked = false);
                
                // Reset location and cascading elements
                countrySelect.value = '';
                populateCountries(); // This re-renders selects and hides cascade containers
                
                // Reset search inputs
                industrySearch.value = '';
                companySearch.value = '';
                
                // Re-show all industry list items
                industryList.querySelectorAll('.filter-option').forEach(o => o.style.display = 'flex');
                
                // Apply filters to reload all companies (since search is cleared)
                filteredCompanies = [...allCompanies];
                renderCompanies();
            };

            // Search companies (updates search term and re-applies filters)
            const searchCompanies = () => {
                // The search term is applied directly inside applyFilters() now
                applyFilters();
            };

            // Render companies list
            const renderCompanies = () => {
                companiesList.innerHTML = '';
                companyCount.textContent = `${filteredCompanies.length} companies found`;
                
                if (filteredCompanies.length === 0) {
                    companiesList.innerHTML = '';
                    noResults.classList.remove('d-none');
                } else {
                    noResults.classList.add('d-none');
                    filteredCompanies.forEach(company => {
                        const companyCard = document.createElement('div');
                        companyCard.className = 'company-card d-flex align-items-center';
                        companyCard.dataset.companyId = company.id;
                        
                        const rating = (Math.random() * 1.5 + 3.5).toFixed(1);
                        const reviewCount = Math.floor(Math.random() * 1000) + 50;
                        
                        // Use placeholder if logo_url is missing or 'N/A'
                        const logoUrl = company.logo_url && company.logo_url !== 'N/A' 
                                        ? company.logo_url 
                                        : 'https://placehold.co/50x50/EFEFEF/AAAAAA&text=Logo';

                        companyCard.innerHTML = `
                            <img src="${logoUrl}" 
                                alt="${company.company_name} Logo" class="company-logo">
                            <div class="company-info">
                                <h4 class="company-name">${company.company_name}</h4>
                                <div class="company-rating">
                                    <span class="rating-stars">${generateStarRating(rating)}</span>
                                    <span class="small text-muted">${rating} | ${reviewCount} reviews</span>
                                </div>
                                <div class="company-type">
                                    ${generateCompanyType(company.company_name)}
                                </div>
                            </div>
                        `;
                        companyCard.addEventListener('click', () => selectCompany(company));
                        companiesList.appendChild(companyCard);
                    });
                }
            };

            // Generate star rating HTML
            const generateStarRating = (rating) => {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= rating) stars += '<i class="fas fa-star"></i>';
                    else if (i - 0.5 <= rating) stars += '<i class="fas fa-star-half-alt"></i>';
                    else stars += '<i class="far fa-star"></i>';
                }
                return stars;
            };

            // Generate company type (for demo purposes)
            const generateCompanyType = (companyName) => {
                const types = ['Foreign MNC / IT Services & Consulting', 'Corporate / Analytics / KPO / Research', 'Startup / Unicorn'];
                let hash = 0;
                for (let i = 0; i < companyName.length; i++) hash = companyName.charCodeAt(i) + ((hash << 5) - hash);
                return types[Math.abs(hash) % types.length];
            };

            // Select a company and show its jobs
            const selectCompany = async (company) => {
                selectedCompany = company;
                companiesView.classList.add('d-none');
                jobsView.classList.remove('d-none');
                
                jobsList.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Loading jobs...</p></div>`;
                
                try {
                    // Filter the stored allJobs array by company ID and current job filters
                    const companyJobs = allJobs.filter(job => job.company_id === company.id && jobMatchesFilters(job));
                    renderJobs(companyJobs);
                } catch (error) {
                    console.error('Error loading company jobs:', error);
                    jobsList.innerHTML = `<div class="alert alert-danger">Failed to load jobs for this company.</div>`;
                }
            };

            // Render jobs list
            const renderJobs = (jobs) => {
                jobsList.innerHTML = '';
                if (jobs.length === 0) {
                    jobsList.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-briefcase"></i>
                            <h4>No Jobs Available</h4>
                            <p>${selectedCompany.company_name} doesn't have any jobs matching the current filters.</p>
                        </div>`;
                    return;
                }
                
                // Add a header for the company name
                jobsList.innerHTML += `<h3 class="fw-bold mb-3">${selectedCompany.company_name} Jobs (${jobs.length})</h3>`;

                jobs.forEach(job => {
                    const jobCard = document.createElement('div');
                    jobCard.className = 'job-card';
                    jobCard.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="job-title">${job.job_title}</h5>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    ${job.city || 'N/A'}, ${job.state || ''} ${job.zip_code ? `(${job.zip_code})` : ''}, ${job.country || ''}
                                </p>
                            </div>
                            <button class="btn btn-primary btn-sm apply-now-btn" data-job-id="${job.id}">Apply Now</button>
                        </div>
                        <div class="job-meta">
                            <span class="job-badge"><i class="fas fa-briefcase me-1"></i>${job.job_type || 'N/A'}</span>
                            <span class="job-badge"><i class="fas fa-laptop me-1"></i>${job.work_location || 'N/A'}</span>
                            ${job.required_experience ? `<span class="job-badge"><i class="fas fa-chart-line me-1"></i>${job.required_experience} years</span>` : ''}
                        </div>
                        <p class="job-description">${job.job_description.substring(0, 150)}...</p>`;
                    jobCard.querySelector('.apply-now-btn').addEventListener('click', (e) => applyForJob(e.target.dataset.jobId));
                    jobsList.appendChild(jobCard);
                });
            };

            // Apply for a job
            const applyForJob = (jobId) => {
                if (sessionStorage.getItem('email')) {
                    window.location.href = `jobApplication.html?jobId=${jobId}`;
                } else {
                    console.warn('User not logged in. Redirecting to login.');
                    window.location.href = 'login.html';
                }
            };

            init();
        });
    </script>
</body>
</html>
